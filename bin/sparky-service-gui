#!/bin/bash
# sparky-service-gui - GUI interface for SparkyOS Service Manager
# Copyright SparkyOS Team
# Under the GNU GPL3 License
#
# Graphical User Interface for managing services and tune schedules
# Works with any Desktop Environment (uses zenity/yad)
# Last update 2025/11/21

# Source required libraries
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

source "${LIB_DIR}/sparky-i18n.sh"
source "${LIB_DIR}/sparky-service-lib.sh"

# Detect language
LANG_CODE=$(detect_language)

# GUI command - prefer yad, fallback to zenity
if command -v yad &>/dev/null; then
    GUI="yad"
elif command -v zenity &>/dev/null; then
    GUI="zenity"
else
    echo "Error: Neither yad nor zenity is installed."
    exit 1
fi

# GUI dimensions
WIDTH=700
HEIGHT=500
LIST_HEIGHT=400

# Check root privileges
check_root() {
    if [ "$EUID" -ne 0 ]; then
        if [ "$GUI" = "yad" ]; then
            yad --title="Error" \
                --text="$(get_string 'ERROR_ROOT_REQUIRED' "$LANG_CODE")" \
                --button="OK:0" \
                --width=400 --height=100
        else
            zenity --error \
                   --title="Error" \
                   --text="$(get_string 'ERROR_ROOT_REQUIRED' "$LANG_CODE")" \
                   --width=400 --height=100
        fi
        exit 1
    fi
}

# Show error message
show_error() {
    local message="$1"
    if [ "$GUI" = "yad" ]; then
        yad --error --title="Error" --text="$message" --button="OK:0"
    else
        zenity --error --title="Error" --text="$message"
    fi
}

# Show info message
show_info() {
    local message="$1"
    if [ "$GUI" = "yad" ]; then
        yad --info --title="Information" --text="$message" --button="OK:0"
    else
        zenity --info --title="Information" --text="$message"
    fi
}

# Show success message
show_success() {
    local message="$1"
    if [ "$GUI" = "yad" ]; then
        yad --info --title="Success" --text="$message" --button="OK:0"
    else
        zenity --info --title="Success" --text="$message"
    fi
}

# Main menu
show_main_menu() {
    while true; do
        local choice

        if [ "$GUI" = "yad" ]; then
            choice=$(yad --title="$(get_string 'APP_TITLE' "$LANG_CODE")" \
                         --text="$(get_string 'APP_DESCRIPTION' "$LANG_CODE")" \
                         --list \
                         --column="Option" \
                         --column="Description" \
                         --width=$WIDTH --height=300 \
                         --button="Exit:1" --button="Select:0" \
                         "1" "$(get_string 'MENU_SERVICE_MANAGER' "$LANG_CODE")" \
                         "2" "$(get_string 'MENU_TUNE_SCHEDULER' "$LANG_CODE")" \
                         "3" "$(get_string 'MENU_VIEW_CONFIG' "$LANG_CODE")" \
                         2>/dev/null | cut -d'|' -f1)
        else
            choice=$(zenity --list \
                            --title="$(get_string 'APP_TITLE' "$LANG_CODE")" \
                            --text="$(get_string 'APP_DESCRIPTION' "$LANG_CODE")" \
                            --column="Option" \
                            --column="Description" \
                            --width=$WIDTH --height=300 \
                            "1" "$(get_string 'MENU_SERVICE_MANAGER' "$LANG_CODE")" \
                            "2" "$(get_string 'MENU_TUNE_SCHEDULER' "$LANG_CODE")" \
                            "3" "$(get_string 'MENU_VIEW_CONFIG' "$LANG_CODE")" \
                            2>/dev/null)
        fi

        [ -z "$choice" ] && break

        case "$choice" in
            1) show_service_menu ;;
            2) show_tune_menu ;;
            3) show_config_view ;;
        esac
    done
}

# Service management menu
show_service_menu() {
    while true; do
        local choice

        if [ "$GUI" = "yad" ]; then
            choice=$(yad --title="$(get_string 'MENU_SERVICE_MANAGER' "$LANG_CODE")" \
                         --text="$(get_string 'SELECT_SERVICES' "$LANG_CODE")" \
                         --list \
                         --column="Option" \
                         --column="Description" \
                         --width=$WIDTH --height=350 \
                         --button="Back:1" --button="Select:0" \
                         "1" "List All Services" \
                         "2" "List Running Services" \
                         "3" "Manage Service" \
                         "4" "Monitor Services" \
                         2>/dev/null | cut -d'|' -f1)
        else
            choice=$(zenity --list \
                            --title="$(get_string 'MENU_SERVICE_MANAGER' "$LANG_CODE")" \
                            --text="$(get_string 'SELECT_SERVICES' "$LANG_CODE")" \
                            --column="Option" \
                            --column="Description" \
                            --width=$WIDTH --height=350 \
                            "1" "List All Services" \
                            "2" "List Running Services" \
                            "3" "Manage Service" \
                            "4" "Monitor Services" \
                            2>/dev/null)
        fi

        [ -z "$choice" ] && break

        case "$choice" in
            1) list_all_services ;;
            2) list_running_services ;;
            3) manage_service ;;
            4) manage_monitored_services ;;
        esac
    done
}

# List all services
list_all_services() {
    local services=$(get_all_services)
    local service_data=""

    while IFS= read -r service; do
        local status=$(get_service_status "$service")
        local enabled=$(get_service_enabled "$service")
        service_data="${service_data}${service}|${status}|${enabled}\n"
    done <<< "$services"

    if [ "$GUI" = "yad" ]; then
        echo -e "$service_data" | yad --list \
                                      --title="All Services" \
                                      --column="Service" \
                                      --column="Status" \
                                      --column="Enabled" \
                                      --width=$WIDTH --height=$LIST_HEIGHT \
                                      --button="OK:0" \
                                      2>/dev/null
    else
        echo -e "$service_data" | zenity --list \
                                         --title="All Services" \
                                         --column="Service" \
                                         --column="Status" \
                                         --column="Enabled" \
                                         --width=$WIDTH --height=$LIST_HEIGHT \
                                         2>/dev/null
    fi
}

# List running services
list_running_services() {
    local services=$(get_running_services)
    local service_data=""

    while IFS= read -r service; do
        local status=$(get_service_status "$service")
        service_data="${service_data}${service}|${status}\n"
    done <<< "$services"

    if [ "$GUI" = "yad" ]; then
        echo -e "$service_data" | yad --list \
                                      --title="Running Services" \
                                      --column="Service" \
                                      --column="Status" \
                                      --width=$WIDTH --height=$LIST_HEIGHT \
                                      --button="OK:0" \
                                      2>/dev/null
    else
        echo -e "$service_data" | zenity --list \
                                         --title="Running Services" \
                                         --column="Service" \
                                         --column="Status" \
                                         --width=$WIDTH --height=$LIST_HEIGHT \
                                         2>/dev/null
    fi
}

# Manage individual service
manage_service() {
    # Get service name from list
    local services=$(get_all_services)
    local service_data=""

    while IFS= read -r service; do
        local status=$(get_service_status "$service")
        service_data="${service_data}${service}|${status}\n"
    done <<< "$services"

    local selected_service

    if [ "$GUI" = "yad" ]; then
        selected_service=$(echo -e "$service_data" | yad --list \
                                                          --title="Select Service" \
                                                          --text="Select a service to manage:" \
                                                          --column="Service" \
                                                          --column="Status" \
                                                          --width=$WIDTH --height=$LIST_HEIGHT \
                                                          --button="Cancel:1" --button="Select:0" \
                                                          2>/dev/null | cut -d'|' -f1)
    else
        selected_service=$(echo -e "$service_data" | zenity --list \
                                                             --title="Select Service" \
                                                             --text="Select a service to manage:" \
                                                             --column="Service" \
                                                             --column="Status" \
                                                             --width=$WIDTH --height=$LIST_HEIGHT \
                                                             2>/dev/null)
    fi

    [ -z "$selected_service" ] && return

    # Show service management options
    while true; do
        local status=$(get_service_status "$selected_service")
        local enabled=$(get_service_enabled "$selected_service")

        local action

        if [ "$GUI" = "yad" ]; then
            action=$(yad --title="Manage: $selected_service" \
                         --text="Status: $status | Enabled: $enabled" \
                         --list \
                         --column="Action" \
                         --width=500 --height=350 \
                         --button="Back:1" --button="Execute:0" \
                         "Start Service" \
                         "Stop Service" \
                         "Restart Service" \
                         "Enable Service" \
                         "Disable Service" \
                         "View Status" \
                         2>/dev/null)
        else
            action=$(zenity --list \
                            --title="Manage: $selected_service" \
                            --text="Status: $status | Enabled: $enabled" \
                            --column="Action" \
                            --width=500 --height=350 \
                            "Start Service" \
                            "Stop Service" \
                            "Restart Service" \
                            "Enable Service" \
                            "Disable Service" \
                            "View Status" \
                            2>/dev/null)
        fi

        [ -z "$action" ] && break

        case "$action" in
            "Start Service")
                if start_service "$selected_service"; then
                    show_success "$(get_string 'SERVICE_STARTED' "$LANG_CODE")"
                else
                    show_error "Failed to start service"
                fi
                ;;
            "Stop Service")
                if stop_service "$selected_service"; then
                    show_success "$(get_string 'SERVICE_STOPPED' "$LANG_CODE")"
                else
                    show_error "Failed to stop service"
                fi
                ;;
            "Restart Service")
                if restart_service "$selected_service"; then
                    show_success "Service restarted successfully"
                else
                    show_error "Failed to restart service"
                fi
                ;;
            "Enable Service")
                if enable_service "$selected_service"; then
                    show_success "Service enabled successfully"
                else
                    show_error "Failed to enable service"
                fi
                ;;
            "Disable Service")
                if disable_service "$selected_service"; then
                    show_success "Service disabled successfully"
                else
                    show_error "Failed to disable service"
                fi
                ;;
            "View Status")
                local full_status=$(systemctl status "$selected_service.service" 2>&1 || true)
                if [ "$GUI" = "yad" ]; then
                    echo "$full_status" | yad --text-info \
                                              --title="Service Status: $selected_service" \
                                              --width=$WIDTH --height=$LIST_HEIGHT \
                                              --button="OK:0" \
                                              2>/dev/null
                else
                    echo "$full_status" | zenity --text-info \
                                                 --title="Service Status: $selected_service" \
                                                 --width=$WIDTH --height=$LIST_HEIGHT \
                                                 2>/dev/null
                fi
                ;;
        esac
    done
}

# Manage monitored services
manage_monitored_services() {
    while true; do
        local choice

        if [ "$GUI" = "yad" ]; then
            choice=$(yad --title="Monitor Services" \
                         --text="Manage service monitoring" \
                         --list \
                         --column="Option" \
                         --column="Description" \
                         --width=600 --height=250 \
                         --button="Back:1" --button="Select:0" \
                         "1" "Add Service to Monitor" \
                         "2" "Remove Service from Monitor" \
                         "3" "View Monitored Services" \
                         2>/dev/null | cut -d'|' -f1)
        else
            choice=$(zenity --list \
                            --title="Monitor Services" \
                            --text="Manage service monitoring" \
                            --column="Option" \
                            --column="Description" \
                            --width=600 --height=250 \
                            "1" "Add Service to Monitor" \
                            "2" "Remove Service from Monitor" \
                            "3" "View Monitored Services" \
                            2>/dev/null)
        fi

        [ -z "$choice" ] && break

        case "$choice" in
            1) add_service_to_monitor ;;
            2) remove_service_from_monitor ;;
            3) view_monitored_services ;;
        esac
    done
}

# Add service to monitoring
add_service_to_monitor() {
    local service

    if [ "$GUI" = "yad" ]; then
        service=$(yad --entry \
                      --title="Add Service" \
                      --text="Enter service name to monitor:" \
                      --width=400 \
                      --button="Cancel:1" --button="Add:0" \
                      2>/dev/null)
    else
        service=$(zenity --entry \
                         --title="Add Service" \
                         --text="Enter service name to monitor:" \
                         --width=400 \
                         2>/dev/null)
    fi

    if [ -n "$service" ]; then
        if add_monitored_service "$service"; then
            show_success "Service $service added to monitoring"
        else
            show_info "Service $service is already monitored"
        fi
    fi
}

# Remove service from monitoring
remove_service_from_monitor() {
    local services=$(get_monitored_services)

    if [ -z "$services" ]; then
        show_info "$(get_string 'NO_SERVICES_SELECTED' "$LANG_CODE")"
        return
    fi

    local service_data=""
    while IFS= read -r service; do
        service_data="${service_data}${service}\n"
    done <<< "$services"

    local selected

    if [ "$GUI" = "yad" ]; then
        selected=$(echo -e "$service_data" | yad --list \
                                                 --title="Remove Service" \
                                                 --text="Select service to remove:" \
                                                 --column="Service" \
                                                 --width=500 --height=400 \
                                                 --button="Cancel:1" --button="Remove:0" \
                                                 2>/dev/null)
    else
        selected=$(echo -e "$service_data" | zenity --list \
                                                    --title="Remove Service" \
                                                    --text="Select service to remove:" \
                                                    --column="Service" \
                                                    --width=500 --height=400 \
                                                    2>/dev/null)
    fi

    if [ -n "$selected" ]; then
        if remove_monitored_service "$selected"; then
            show_success "Service $selected removed from monitoring"
        fi
    fi
}

# View monitored services
view_monitored_services() {
    local services=$(get_monitored_services)

    if [ -z "$services" ]; then
        show_info "$(get_string 'NO_SERVICES_SELECTED' "$LANG_CODE")"
    else
        local service_data=""
        while IFS= read -r service; do
            local status=$(get_service_status "$service")
            service_data="${service_data}${service}|${status}\n"
        done <<< "$services"

        if [ "$GUI" = "yad" ]; then
            echo -e "$service_data" | yad --list \
                                          --title="Monitored Services" \
                                          --column="Service" \
                                          --column="Status" \
                                          --width=600 --height=400 \
                                          --button="OK:0" \
                                          2>/dev/null
        else
            echo -e "$service_data" | zenity --list \
                                             --title="Monitored Services" \
                                             --column="Service" \
                                             --column="Status" \
                                             --width=600 --height=400 \
                                             2>/dev/null
        fi
    fi
}

# Tune scheduler menu
show_tune_menu() {
    while true; do
        local choice

        if [ "$GUI" = "yad" ]; then
            choice=$(yad --title="$(get_string 'MENU_TUNE_SCHEDULER' "$LANG_CODE")" \
                         --text="Manage sound schedules" \
                         --list \
                         --column="Option" \
                         --column="Description" \
                         --width=600 --height=300 \
                         --button="Back:1" --button="Select:0" \
                         "1" "Add Tune Schedule" \
                         "2" "Remove Tune Schedule" \
                         "3" "View Tune Schedules" \
                         "4" "Test Sound" \
                         2>/dev/null | cut -d'|' -f1)
        else
            choice=$(zenity --list \
                            --title="$(get_string 'MENU_TUNE_SCHEDULER' "$LANG_CODE")" \
                            --text="Manage sound schedules" \
                            --column="Option" \
                            --column="Description" \
                            --width=600 --height=300 \
                            "1" "Add Tune Schedule" \
                            "2" "Remove Tune Schedule" \
                            "3" "View Tune Schedules" \
                            "4" "Test Sound" \
                            2>/dev/null)
        fi

        [ -z "$choice" ] && break

        case "$choice" in
            1) add_tune_schedule_dialog ;;
            2) remove_tune_schedule_dialog ;;
            3) view_tune_schedules ;;
            4) test_sound_dialog ;;
        esac
    done
}

# Add tune schedule dialog
add_tune_schedule_dialog() {
    local form_data

    if [ "$GUI" = "yad" ]; then
        form_data=$(yad --form \
                        --title="Add Tune Schedule" \
                        --field="Service Name:" "" \
                        --field="Time (HH:MM):" "09:00" \
                        --field="Days (* for all, 0-6 for specific):" "*" \
                        --width=500 \
                        --button="Cancel:1" --button="Next:0" \
                        2>/dev/null)
    else
        # Zenity doesn't have form, so use multiple entries
        local service=$(zenity --entry --title="Add Tune Schedule" --text="Enter service name:" 2>/dev/null)
        [ -z "$service" ] && return
        local time=$(zenity --entry --title="Add Tune Schedule" --text="Enter time (HH:MM):" --entry-text="09:00" 2>/dev/null)
        [ -z "$time" ] && return
        local days=$(zenity --entry --title="Add Tune Schedule" --text="Days (* for all, 0-6 for specific):" --entry-text="*" 2>/dev/null)
        [ -z "$days" ] && return
        form_data="${service}|${time}|${days}"
    fi

    [ -z "$form_data" ] && return

    local service=$(echo "$form_data" | cut -d'|' -f1)
    local time=$(echo "$form_data" | cut -d'|' -f2)
    local days=$(echo "$form_data" | cut -d'|' -f3)

    # Get available sounds
    local sounds=$(get_available_sounds)
    local sound_data=""

    while IFS= read -r sound; do
        sound_data="${sound_data}${sound}\n"
    done <<< "$sounds"

    local selected_sound

    if [ "$GUI" = "yad" ]; then
        selected_sound=$(echo -e "$sound_data" | yad --list \
                                                      --title="$(get_string 'SELECT_TUNE' "$LANG_CODE")" \
                                                      --text="$(get_string 'SELECT_TUNE' "$LANG_CODE")" \
                                                      --column="Sound File" \
                                                      --width=600 --height=400 \
                                                      --button="Cancel:1" --button="Select:0" \
                                                      2>/dev/null)
    else
        selected_sound=$(echo -e "$sound_data" | zenity --list \
                                                        --title="$(get_string 'SELECT_TUNE' "$LANG_CODE")" \
                                                        --text="$(get_string 'SELECT_TUNE' "$LANG_CODE")" \
                                                        --column="Sound File" \
                                                        --width=600 --height=400 \
                                                        2>/dev/null)
    fi

    [ -z "$selected_sound" ] && return

    # Add schedule
    if add_tune_schedule "$service" "$time" "$selected_sound" "$days"; then
        show_success "$(get_string 'CONFIG_SAVED' "$LANG_CODE")\n\nService: $service\nTime: $time\nSound: $selected_sound\nDays: $days"
    else
        show_error "Failed to add tune schedule. Check time format (HH:MM)"
    fi
}

# Remove tune schedule dialog
remove_tune_schedule_dialog() {
    local tunes=$(get_all_tunes)

    if [ -z "$tunes" ]; then
        show_info "No tune schedules configured"
        return
    fi

    local tune_data=""

    while IFS=: read -r service time sound days; do
        tune_data="${tune_data}${service}|${time}|${sound}|${days}\n"
    done <<< "$tunes"

    local selected

    if [ "$GUI" = "yad" ]; then
        selected=$(echo -e "$tune_data" | yad --list \
                                              --title="Remove Tune Schedule" \
                                              --text="Select schedule to remove:" \
                                              --column="Service" \
                                              --column="Time" \
                                              --column="Sound" \
                                              --column="Days" \
                                              --width=$WIDTH --height=400 \
                                              --button="Cancel:1" --button="Remove:0" \
                                              2>/dev/null)
    else
        selected=$(echo -e "$tune_data" | zenity --list \
                                                 --title="Remove Tune Schedule" \
                                                 --text="Select schedule to remove:" \
                                                 --column="Service" \
                                                 --column="Time" \
                                                 --column="Sound" \
                                                 --column="Days" \
                                                 --width=$WIDTH --height=400 \
                                                 2>/dev/null)
    fi

    if [ -n "$selected" ]; then
        local service=$(echo "$selected" | cut -d'|' -f1)
        local time=$(echo "$selected" | cut -d'|' -f2)

        if remove_tune_schedule "$service" "$time"; then
            show_success "Tune schedule removed"
        fi
    fi
}

# View tune schedules
view_tune_schedules() {
    local tunes=$(get_all_tunes)

    if [ -z "$tunes" ]; then
        show_info "No tune schedules configured"
    else
        local tune_data=""

        while IFS=: read -r service time sound days; do
            tune_data="${tune_data}${service}|${time}|${sound}|${days}\n"
        done <<< "$tunes"

        if [ "$GUI" = "yad" ]; then
            echo -e "$tune_data" | yad --list \
                                       --title="Tune Schedules" \
                                       --column="Service" \
                                       --column="Time" \
                                       --column="Sound" \
                                       --column="Days" \
                                       --width=$WIDTH --height=400 \
                                       --button="OK:0" \
                                       2>/dev/null
        else
            echo -e "$tune_data" | zenity --list \
                                          --title="Tune Schedules" \
                                          --column="Service" \
                                          --column="Time" \
                                          --column="Sound" \
                                          --column="Days" \
                                          --width=$WIDTH --height=400 \
                                          2>/dev/null
        fi
    fi
}

# Test sound
test_sound_dialog() {
    local sounds=$(get_available_sounds)
    local sound_data=""

    while IFS= read -r sound; do
        sound_data="${sound_data}${sound}\n"
    done <<< "$sounds"

    local selected_sound

    if [ "$GUI" = "yad" ]; then
        selected_sound=$(echo -e "$sound_data" | yad --list \
                                                      --title="Test Sound" \
                                                      --text="Select sound to test:" \
                                                      --column="Sound File" \
                                                      --width=600 --height=400 \
                                                      --button="Cancel:1" --button="Play:0" \
                                                      2>/dev/null)
    else
        selected_sound=$(echo -e "$sound_data" | zenity --list \
                                                        --title="Test Sound" \
                                                        --text="Select sound to test:" \
                                                        --column="Sound File" \
                                                        --width=600 --height=400 \
                                                        2>/dev/null)
    fi

    if [ -n "$selected_sound" ]; then
        local sound_path=$(get_sound_path "$selected_sound")

        if [ -n "$sound_path" ]; then
            play_sound "$sound_path"
            show_info "Playing: $selected_sound"
        else
            show_error "Sound file not found: $selected_sound"
        fi
    fi
}

# View configuration
show_config_view() {
    local config_file=$(export_config)

    if [ "$GUI" = "yad" ]; then
        cat "$config_file" | yad --text-info \
                                 --title="$(get_string 'MENU_VIEW_CONFIG' "$LANG_CODE")" \
                                 --width=$WIDTH --height=$LIST_HEIGHT \
                                 --button="OK:0" \
                                 2>/dev/null
    else
        cat "$config_file" | zenity --text-info \
                                    --title="$(get_string 'MENU_VIEW_CONFIG' "$LANG_CODE")" \
                                    --width=$WIDTH --height=$LIST_HEIGHT \
                                    2>/dev/null
    fi

    rm -f "$config_file"
}

# Main execution
main() {
    check_root
    init_config
    show_main_menu
}

main "$@"
